<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Event Registration for routechoices.com</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" href='./favicon.svg' />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
        <link rel="stylesheet" href="https://www.routechoices.com/static/vendor/font-awesome-4.7.0/css/font-awesome.min.css"/>
        <style>
            .swal-button {
                background-color:#0275d8;
                color:#fff;
                border:none;
                box-shadow:none;
                border-radius:5px;
                font-weight:600;
                font-size:14px;
                padding:10px 24px;
                margin:0;
                cursor:pointer
               }
               .swal-button:not([disabled]):hover {
                background-color:#06c
            }
            .swal-button:active {
                background-color:#0275d8
            }
            .swal-button:focus {
                outline:none;
                box-shadow: none
             }
            .swal-button[disabled] {
                opacity:.5;
                cursor:default
            }
            .swal-button::-moz-focus-inner {
                border:0
            }
        </style>
    </head>
    <body>
    <div class="container">
        <div style="text-align: center"><img src="logo.png" alt="logo" width="256">
        <div id="p1">
            <h1>Settings</h1>
            <form id="form1">
                <label for="name" class="form-label">Name</label>
                <input class="form-control" type="text" id="name" name="name" required/>
                <label for="sname" class="form-label">Short Name</label>
                <input class="form-control" type="text" id="sname" name="sname" required/>
                <label for="devid" class="form-label">Device ID:</label>
                <input class="form-control" type="text" id="devid" name="devid" required/>
                <input style="margin-top:15px" class="form-control btn btn-primary" type="submit" value="Save" />
            </form>
        </div>
        <div id="p2" class="d-none">
            <div><button class="btn user-setting-btn"><i class="fa fa-cog"></i> settings</button> <button class="btn refresh-btn"><i class="fa fa-refresh"></i> refresh</button></div>
            <h1>Event Selection</h1>
            <form id="form2">
                <label for="events" class="form-label">Event:</label>
                <select class="form-select" id="events" name="events" onchange="onEventSelect()"></select>
                <p id="warningA" class="d-none">
                    <i class="fa fa-warning"></i> You can stream your GPS data to only one competitor at a time. If you register now, your GPS data stream will be switched to this competitor immediately.
                </p>
                <p id="warningB" class="d-none">
                    <i class="fa fa-warning"></i> You can stream your GPS data to only one competitor at a time. If you register now, your GPS data stream will be switched to this competitor at latest on <span id="event_start"></span>
                </p>
                <input style="margin-top:15px" class="form-control btn btn-primary" type="submit" value="Register for event" />
            </form>
            
        </div>
        <div id="p3" class="d-none">
            <div><button class="btn user-setting-btn"><i class="fa fa-cog"></i> settings</button> <button class="btn refresh-btn"><i class="fa fa-refresh"></i> refresh</button></div>
            <h1><i class="fa fa-warning" style="color:crimson"></i> No events to register.</h1>
        </div>
        <div id="p4" class="d-none">
            <div><button class="btn user-setting-btn"><i class="fa fa-cog"></i> settings</button> <button class="btn refresh-btn"><i class="fa fa-refresh"></i> refresh</button></div>
            <h1><i class="fa fa-success" style="color:green"></i> You have been registered.</h1>
        </div>
    </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
    <script src="https://www.routechoices.com/static/vendor/dayjs-1.10.6/dayjs.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script>
    var userInfo = window.localStorage.getItem('userInfo');
    var myUrl = new URL(window.location.href.replace(/#/g,"?"));
    var devid = myUrl.searchParams.get("device_id");
    document.getElementById('devid').value = devid || '';
    if (userInfo){
        try {
        userInfo = JSON.parse(userInfo);
        console.log(userInfo);
        document.getElementById('name').value = userInfo.name;
        document.getElementById('sname').value = userInfo.short_name;
        document.getElementById('devid').value = devid || userInfo.devid || '';
        document.getElementById('p1').classList.add('d-none');
        fetchEvents();
        } catch (e) {
            document.getElementById('p2').classList.add('d-none')
            document.getElementById('p1').classList.remove('d-none')
        }
    } else {
        document.getElementById('p2').classList.add('d-none')
        document.getElementById('p1').classList.remove('d-none')
    }
    document.getElementById('form1').onsubmit = function(ev) {
        ev.preventDefault();
        userInfo = {}
        userInfo.name = document.getElementById('name').value;
        userInfo.short_name = document.getElementById('sname').value;
        userInfo.devid = document.getElementById('devid').value;
        window.localStorage.setItem('userInfo', JSON.stringify(userInfo));
        document.getElementById('p1').classList.add('d-none')
        fetchEvents();
    };
    document.getElementById('form2').onsubmit = function(ev) {
        ev.preventDefault();
        data = {}
        data.name = document.getElementById('name').value;
        data.short_name = document.getElementById('sname').value;
        data.device_id = document.getElementById('devid').value;
        ev_id = document.getElementById('events').value;
        fetch('https://api.routechoices.com/events/'+ ev_id + '/register/',
        {
            method: 'POST',
            credentials: 'omit',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        }).then(function(r){
            return r.json()
        }).then(function(data){
            if (!data.id){
                if(data instanceof Array) {
                    swal(data.join('\r\n'))
                } else {
                    swal('Something went wrong.')
                }
                return
            }
            document.getElementById('p2').classList.add('d-none')
            document.getElementById('p4').classList.remove('d-none')
        }).catch(function(e){
            swal('Something went wrong.')
        })
    };
    Array.from(document.getElementsByClassName('user-setting-btn'))
    .map(function(el){el.addEventListener("click", function(e){
        document.getElementById('p2').classList.add('d-none')
        document.getElementById('p3').classList.add('d-none')
        document.getElementById('p4').classList.add('d-none')
        document.getElementById('p1').classList.remove('d-none')
    })})
    Array.from(document.getElementsByClassName('refresh-btn'))
    .map(function(el){el.addEventListener("click", function(e){
        window.location.reload()
    })})
    function onEventSelect(){
        var select = document.getElementById('events');
        var value = select.options[select.selectedIndex].value;
        e = events.find(function(ev){return ev.id===value});
        console.log(e, dayjs(e.start_date) < dayjs())
        if(dayjs(e.start_date) < dayjs()) {
            document.getElementById('warningA').classList.remove('d-none')
            document.getElementById('warningB').classList.add('d-none')
        } else {
            document.getElementById('warningA').classList.add('d-none')
            document.getElementById('warningB').classList.remove('d-none')
            document.getElementById('event_start').innerHTML = dayjs(e.start_date).local().format('MMMM D, YYYY [at] HH:mm:ss')
        }
    }
    
    var events = [];
    function fetchEvents() {
        fetch('https://api.routechoices.com/events', {method: 'GET'})
            .then(function(r){return r.json()})
            .then(function(evs) {
                events = evs.filter(function(e){return e.open_registration && (!e.end_date || dayjs(e.end_date) > dayjs())}).map(function(e){return {id: e.id, name: e.name + ' - ' + e.club, start_date: e.start_date}});
                if(events.length === 0) {
                    document.getElementById('p3').classList.remove('d-none')
                } else {
                    document.getElementById('events').innerHTML = ''
                    document.getElementById('p2').classList.remove('d-none')
                    events.forEach(function(ev)
                    {
                        var opt = document.createElement("option");
                        opt.setAttribute('value', ev.id);
                        opt.appendChild(document.createTextNode(ev.name));
                        document.getElementById('events').appendChild(opt);
                    })
                    onEventSelect({target:{value:events[0].id}})
                }}
            )
    }
    </script>    
</body>
</html>
